{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">

  <!-- Loan Portfolio Speedometer -->
  <div class="row mb-4">
    <div class="col text-center">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="fw-bold mb-3">Loan Portfolio Overview</h4>
          <div style="max-width: 280px; margin: 0 auto;">
            <canvas id="loanSpeedometer" width="300" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loan Summary -->
  <div class="row mb-4">
    <div class="col">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="fw-bold mb-3">Loan Summary</h4>
          <div class="row text-center">
            <div class="col-md-2">
              <p class="mb-1">Total Loans</p>
              <h5>{{ stats.total_loans }}</h5>
            </div>
            <div class="col-md-2">
              <p class="mb-1">Active Borrowers</p>
              <h5 class="text-primary">{{ stats.active_borrowers }}</h5>
            </div>
            <div class="col-md-2">
              <p class="mb-1">Inactive Borrowers</p>
              <h5 class="text-warning">{{ stats.inactive_borrowers }}</h5>
            </div>
            <div class="col-md-2">
              <p class="mb-1">Critical Loans</p>
              <h5 class="text-danger">{{ stats.critical_loans }}</h5>
            </div>
            <div class="col-md-2">
              <p class="mb-1">Missing Contract</p>
              <h5 class="text-warning">{{ stats.missing_contract }}</h5>
            </div>
            <div class="col-md-2">
              <p class="mb-1">Loans w/ Title</p>
              <h5 class="text-success">{{ stats.title_loans }}</h5>
            </div>
            <div class="col-md-2 mt-3">
              <p class="mb-1">With Guarantor</p>
              <h5 class="text-success">{{ stats.with_guarantor }}</h5>
            </div>
            <div class="col-md-2 mt-3">
              <p class="mb-1">No Title & No Guarantor</p>
              <h5>{{ stats.no_title_guarantor }}</h5>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loan Health Charts -->
  <div class="row mb-4">
    <div class="col">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="fw-bold mb-3">Loan Health Charts</h4>
          <div class="row text-center">
            {% for chart, data in charts_data.items() %}
            <div class="col-md-2">
              <canvas id="{{ chart }}Chart"></canvas>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Embedded chart data -->
<script id="chart-data" type="application/json">
    {{ charts_data | tojson | safe }}
</script>

<!-- Embedded stats data (âœ… new) -->
<script id="stats-data" type="application/json">
    {{ stats | tojson | safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.3"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const charts = JSON.parse(document.getElementById("chart-data").textContent);
    const stats = JSON.parse(document.getElementById("stats-data").textContent);

    function drawPieChart(id, data) {
      const ctx = document.getElementById(id).getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: Object.keys(data),
          datasets: [{
            data: Object.values(data),
            backgroundColor: ["#4CAF50", "#FFC107", "#2196F3", "#F44336", "#9C27B0", "#FF5722"]
          }]
        },
        options: {
          cutout: "70%",
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    for (const chart in charts) {
      drawPieChart(chart + "Chart", charts[chart]);
    }

    const paid = Number(stats.paid_off || 0);
    const pastDue = Number(stats.loans_past_due || 0);
    const total = Number(stats.total_loans || 0);
    const good = Math.max(0, total - paid - pastDue);

    const paidPct = (paid / total) * 100;
    const goodPct = (good / total) * 100;
    const pastPct = (pastDue / total) * 100;

    const centerLabel = 'COVERED';
    const percentLabel = `${paidPct.toFixed(0)}%`;

    const ctx = document.getElementById("loanSpeedometer").getContext("2d");
    const gaugeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Past Due', 'In Good Standing', 'Paid Off', 'Empty'],
        datasets: [{
          data: [pastPct, goodPct, paidPct, 100 - (pastPct + goodPct + paidPct)],
          backgroundColor: ['#F44336', '#FFC107', '#4CAF50', 'transparent'],
          borderWidth: 10,
          borderColor: ['#F44336', '#FFC107', '#4CAF50', 'transparent'],
          cutout: '80%',
          circumference: 270,
          rotation: 225
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        animation: {
          onComplete: function () {
            const chart = this.chart;
            const { width, height } = chart;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 * 0.8;

            const ctx = chart.ctx;
            ctx.save();

            // Draw center text
            ctx.fillStyle = '#444';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(centerLabel, centerX, centerY);
            ctx.font = 'bold 22px Arial';
            ctx.fillText(percentLabel, centerX, centerY + 25);

            // Draw needle
            const angle = (225 + (paidPct * 270 / 100)) * Math.PI / 180;
            const needleLength = radius * 0.9;
            const endX = centerX + needleLength * Math.cos(angle);
            const endY = centerY + needleLength * Math.sin(angle);

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = '#4285F4';
            ctx.fill();

            ctx.restore();
          }
        }
      }
    });
  }); 
</script>
{% endblock %}