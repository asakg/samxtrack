{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-2 bg-light min-vh-100">
            <div class="py-4 text-center">
                <img src="/static/logo.png" alt="Logo" style="height: 50px;">
            </div>
            <ul class="nav flex-column fw-bold">
                <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/loan-summary">Loan Summary</a></li>
                <li class="nav-item"><a class="nav-link" href="/loan-health">Loan Health</a></li>
                <li class="nav-item"><a class="nav-link" href="/loan-stats">Loan Stats</a></li>
                <li class="nav-item"><a class="nav-link" href="/medium-risk">Medium Risk Loans</a></li>
                <li class="nav-item"><a class="nav-link" href="/high-risk">High Risk</a></li>
                <li class="nav-item"><a class="nav-link" href="/take-action">Take Action</a></li>
                <li class="nav-item"><a class="nav-link text-danger" href="/logout">Logout</a></li>
            </ul>
        </div>

        <div class="col-md-10">
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="fw-bold mb-3">Loan Summary</h4>
                                <div class="row text-center">
                                    <div class="col-md-2"><p class="mb-1">Total Loans</p><h5>{{ stats.total_loans }}</h5></div>
                                    <div class="col-md-2"><p class="mb-1">Active Borrowers</p><h5 class="text-primary">{{ stats.active_borrowers }}</h5></div>
                                    <div class="col-md-2"><p class="mb-1">Inactive Borrowers</p><h5 class="text-warning">{{ stats.inactive_borrowers }}</h5></div>
                                    <div class="col-md-2"><p class="mb-1">Critical Loans</p><h5 class="text-danger">{{ stats.critical_loans }}</h5></div>
                                    <div class="col-md-2"><p class="mb-1">Missing Contract</p><h5 class="text-warning">{{ stats.missing_contract }}</h5></div>
                                    <div class="col-md-2"><p class="mb-1">Loans w/ Title</p><h5 class="text-success">{{ stats.title_loans }}</h5></div>
                                    <div class="col-md-2 mt-3"><p class="mb-1">With Guarantor</p><h5 class="text-success">{{ stats.with_guarantor }}</h5></div>
                                    <div class="col-md-2 mt-3"><p class="mb-1">No Title & No Guarantor</p><h5>{{ stats.no_title_guarantor }}</h5></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loan Health Charts -->
                <div class="row mb-4">
                    <div class="col">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="fw-bold mb-3">Loan Health Charts</h4>
                                <div class="row text-center">
                                    {% for chart, data in charts_data.items() %}
                                    <div class="col-md-2 mb-4">
                                        <canvas id="{{ chart }}Chart" width="100" height="100"></canvas>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loan Portfolio Stats -->
                <div class="row mb-4">
                    <div class="col">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="fw-bold mb-3">Loan Portfolio Stats</h4>
                                <div class="row text-center">
                                    {% for label, value in stats_block3.items() %}
                                    <div class="col-md-2">
                                        <p class="text-muted small">{{ label }}</p>
                                        <h5 class="text-primary">{{ value }}</h5>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="chart-data" type="application/json">
    {{ charts_data | tojson | safe }}
</script>
<script>
    const charts = JSON.parse(document.getElementById("chart-data").textContent);

    function drawDonutChart(id, data) {
        const ctx = document.getElementById(id).getContext("2d");
        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: Object.keys(data),
                datasets: [{
                    label: "Distribution",
                    data: Object.values(data),
                    backgroundColor: [
                        "#4CAF50", "#FFC107", "#2196F3", "#F44336", "#9C27B0", "#FF5722"
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                cutout: "60%",
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || "";
                                let value = context.raw || 0;
                                return `${label}: ${value}`;
                            }
                        }
                    },
                    legend: {
                        position: "bottom"
                    }
                }
            }
        });
    }

    for (const chart in charts) {
        drawDonutChart(chart + "Chart", charts[chart]);
    }
</script>
{% endblock %}